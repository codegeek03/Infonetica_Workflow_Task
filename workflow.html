<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 Workflow Engine Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.0/cdn.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .state-badge {
            @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;
        }
        
        .state-initial { @apply bg-green-100 text-green-800; }
        .state-active { @apply bg-blue-100 text-blue-800; }
        .state-final { @apply bg-purple-100 text-purple-800; }
        
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50" x-data="workflowApp()">
    <!-- Header -->
    <header class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <h1 class="text-3xl font-bold text-white">🚀 Workflow Engine</h1>
                    <span class="ml-3 px-2 py-1 bg-white bg-opacity-20 rounded-full text-white text-sm">Dashboard</span>
                </div>
                <div class="flex space-x-4">
                    <button @click="activeTab = 'definitions'" 
                            :class="activeTab === 'definitions' ? 'bg-white text-purple-600' : 'text-white border-white'"
                            class="px-4 py-2 rounded-lg border-2 transition-all duration-200 hover:bg-white hover:text-purple-600">
                        📋 Definitions
                    </button>
                    <button @click="activeTab = 'instances'" 
                            :class="activeTab === 'instances' ? 'bg-white text-purple-600' : 'text-white border-white'"
                            class="px-4 py-2 rounded-lg border-2 transition-all duration-200 hover:bg-white hover:text-purple-600">
                        🏃 Instances
                    </button>
                    <button @click="activeTab = 'create'" 
                            :class="activeTab === 'create' ? 'bg-white text-purple-600' : 'text-white border-white'"
                            class="px-4 py-2 rounded-lg border-2 transition-all duration-200 hover:bg-white hover:text-purple-600">
                        ➕ Create
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Connection Status -->
        <div class="mb-6 p-4 rounded-lg" :class="connected ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'">
            <div class="flex items-center">
                <div class="w-3 h-3 rounded-full mr-3" :class="connected ? 'bg-green-500 pulse-dot' : 'bg-red-500'"></div>
                <span class="font-medium" :class="connected ? 'text-green-800' : 'text-red-800'">
                    <span x-text="connected ? '✅ Connected to Workflow Engine' : '❌ Connection Failed'"></span>
                    <span class="text-sm ml-2" x-text="apiUrl"></span>
                </span>
                <button @click="checkConnection()" class="ml-auto px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 transition-colors">
                    🔄 Refresh
                </button>
            </div>
        </div>

        <!-- Workflow Definitions Tab -->
        <div x-show="activeTab === 'definitions'" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform translate-y-4" x-transition:enter-end="opacity-100 transform translate-y-0">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">📋 Workflow Definitions</h2>
                <button @click="loadDefinitions()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    🔄 Refresh
                </button>
            </div>
            
            <div x-show="loading" class="flex justify-center py-8">
                <div class="loading-spinner"></div>
                <span class="ml-3 text-gray-600">Loading definitions...</span>
            </div>
            
            <div x-show="!loading" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                <template x-for="definition in definitions" :key="definition.id">
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover transition-all duration-200">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-lg font-semibold text-gray-900" x-text="definition.name"></h3>
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                                <span x-text="definition.states.length"></span> states
                            </span>
                        </div>
                        <p class="text-gray-600 mb-4" x-text="definition.description"></p>
                        
                        <div class="mb-4">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">States:</h4>
                            <div class="flex flex-wrap gap-1">
                                <template x-for="state in definition.states" :key="state.id">
                                    <span class="state-badge" :class="state.isInitial ? 'state-initial' : (state.isFinal ? 'state-final' : 'state-active')" x-text="state.name"></span>
                                </template>
                            </div>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button @click="startInstance(definition.id)" 
                                    class="flex-1 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                                ▶️ Start Instance
                            </button>
                            <button @click="viewDefinition(definition)" 
                                    class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm">
                                👁️ View
                            </button>
                        </div>
                    </div>
                </template>
            </div>
            
            <div x-show="!loading && definitions.length === 0" class="text-center py-12">
                <div class="text-6xl mb-4">📝</div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No workflow definitions found</h3>
                <p class="text-gray-600 mb-4">Create your first workflow to get started!</p>
                <button @click="activeTab = 'create'" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                    ➕ Create Workflow
                </button>
            </div>
        </div>

        <!-- Workflow Instances Tab -->
        <div x-show="activeTab === 'instances'" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform translate-y-4" x-transition:enter-end="opacity-100 transform translate-y-0">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">🏃 Workflow Instances</h2>
                <button @click="loadInstances()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    🔄 Refresh
                </button>
            </div>
            
            <div x-show="loading" class="flex justify-center py-8">
                <div class="loading-spinner"></div>
                <span class="ml-3 text-gray-600">Loading instances...</span>
            </div>
            
            <div x-show="!loading" class="space-y-4">
                <template x-for="instance in instances" :key="instance.id">
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover transition-all duration-200">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Instance <span x-text="instance.id.slice(-8)"></span></h3>
                                <p class="text-sm text-gray-600">Definition: <span x-text="instance.definitionId.slice(-8)"></span></p>
                            </div>
                            <div class="text-right">
                                <span class="state-badge state-active" x-text="instance.currentState"></span>
                                <p class="text-xs text-gray-500 mt-1" x-text="new Date(instance.createdAt).toLocaleString()"></p>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Available Actions:</h4>
                            <div class="flex flex-wrap gap-2" x-show="getAvailableActions(instance).length > 0">
                                <template x-for="action in getAvailableActions(instance)" :key="action.id">
                                    <button @click="executeAction(instance.id, action.id)" 
                                            class="px-3 py-1 bg-orange-600 text-white rounded hover:bg-orange-700 transition-colors text-sm">
                                        ⚡ <span x-text="action.name"></span>
                                    </button>
                                </template>
                            </div>
                            <p x-show="getAvailableActions(instance).length === 0" class="text-sm text-gray-500 italic">No actions available</p>
                        </div>
                        
                        <div>
                            <button @click="toggleHistory(instance.id)" 
                                    class="text-sm text-blue-600 hover:text-blue-800 transition-colors">
                                📚 <span x-text="showHistory[instance.id] ? 'Hide' : 'Show'"></span> History
                            </button>
                            <div x-show="showHistory[instance.id]" x-transition class="mt-3 p-3 bg-gray-50 rounded-lg">
                                <template x-for="(entry, index) in instance.history" :key="index">
                                    <div class="flex items-center text-sm py-1">
                                        <span class="w-2 h-2 bg-blue-500 rounded-full mr-3"></span>
                                        <span x-text="entry.fromState || 'Started'"></span>
                                        <span class="mx-2">→</span>
                                        <span class="font-medium" x-text="entry.toState"></span>
                                        <span class="ml-auto text-gray-500" x-text="new Date(entry.timestamp).toLocaleString()"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
            
            <div x-show="!loading && instances.length === 0" class="text-center py-12">
                <div class="text-6xl mb-4">🏃</div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No workflow instances found</h3>
                <p class="text-gray-600 mb-4">Start a workflow instance to see it here!</p>
                <button @click="activeTab = 'definitions'" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    ▶️ Start Instance
                </button>
            </div>
        </div>

        <!-- Create Workflow Tab -->
        <div x-show="activeTab === 'create'" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform translate-y-4" x-transition:enter-end="opacity-100 transform translate-y-0">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">➕ Create New Workflow</h2>
            
            <div class="bg-white rounded-xl shadow-lg p-8">
                <form @submit.prevent="createWorkflow()">
                    <div class="grid gap-6 md:grid-cols-2">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Workflow Name</label>
                            <input x-model="newWorkflow.name" type="text" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500"
                                   placeholder="Enter workflow name" required>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea x-model="newWorkflow.description" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500"
                                      placeholder="Describe your workflow"></textarea>
                        </div>
                    </div>
                    
                    <div class="mt-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium text-gray-900">States</h3>
                            <button type="button" @click="addState()" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm">
                                ➕ Add State
                            </button>
                        </div>
                        
                        <div class="space-y-3">
                            <template x-for="(state, index) in newWorkflow.states" :key="index">
                                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <input x-model="state.id" type="text" placeholder="State ID" 
                                           class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm" required>
                                    <input x-model="state.name" type="text" placeholder="State Name" 
                                           class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm" required>
                                    <label class="flex items-center text-sm">
                                        <input x-model="state.isInitial" type="checkbox" class="mr-1"> Initial
                                    </label>
                                    <label class="flex items-center text-sm">
                                        <input x-model="state.isFinal" type="checkbox" class="mr-1"> Final
                                    </label>
                                    <button type="button" @click="removeState(index)" class="text-red-600 hover:text-red-800 text-sm">
                                        🗑️
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <div class="mt-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium text-gray-900">Actions</h3>
                            <button type="button" @click="addAction()" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-sm">
                                ➕ Add Action
                            </button>
                        </div>
                        
                        <div class="space-y-3">
                            <template x-for="(action, index) in newWorkflow.actions" :key="index">
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <div class="flex items-center space-x-3 mb-2">
                                        <input x-model="action.id" type="text" placeholder="Action ID" 
                                               class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm" required>
                                        <input x-model="action.name" type="text" placeholder="Action Name" 
                                               class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm" required>
                                        <button type="button" @click="removeAction(index)" class="text-red-600 hover:text-red-800 text-sm">
                                            🗑️
                                        </button>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <select x-model="action.toState" class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm" required>
                                            <option value="">Select target state</option>
                                            <template x-for="state in newWorkflow.states" :key="state.id">
                                                <option :value="state.id" x-text="state.name"></option>
                                            </template>
                                        </select>
                                        <div class="flex-1">
                                            <label class="block text-xs text-gray-600 mb-1">From States (comma-separated IDs)</label>
                                            <input x-model="action.fromStatesStr" type="text" placeholder="state1,state2" 
                                                   class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <div class="mt-8 flex space-x-4">
                        <button type="submit" :disabled="creating" 
                                class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50">
                            <span x-show="!creating">🚀 Create Workflow</span>
                            <span x-show="creating">Creating...</span>
                        </button>
                        <button type="button" @click="resetForm()" 
                                class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                            🔄 Reset Form
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Notification Toast -->
    <div x-show="notification.show" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform translate-y-2" x-transition:enter-end="opacity-100 transform translate-y-0" 
         class="fixed bottom-4 right-4 p-4 rounded-lg shadow-lg max-w-sm" :class="notification.type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'">
        <div class="flex items-center">
            <span class="mr-2" x-text="notification.type === 'success' ? '✅' : '❌'"></span>
            <span x-text="notification.message"></span>
            <button @click="notification.show = false" class="ml-auto text-white hover:text-gray-200">✕</button>
        </div>
    </div>

    <script>
        function workflowApp() {
            return {
                activeTab: 'definitions',
                apiUrl: 'http://localhost:5191/api',
                connected: false,
                loading: false,
                creating: false,
                definitions: [],
                instances: [],
                showHistory: {},
                notification: {
                    show: false,
                    message: '',
                    type: 'success'
                },
                newWorkflow: {
                    name: '',
                    description: '',
                    states: [],
                    actions: []
                },

                async init() {
                    await this.checkConnection();
                    if (this.connected) {
                        await this.loadDefinitions();
                    }
                },

                async checkConnection() {
                    try {
                        const response = await fetch(`${this.apiUrl}/workflows`);
                        this.connected = response.ok;
                    } catch (error) {
                        this.connected = false;
                    }
                },

                async loadDefinitions() {
                    this.loading = true;
                    try {
                        const response = await fetch(`${this.apiUrl}/workflows`);
                        if (response.ok) {
                            this.definitions = await response.json();
                        } else {
                            this.showNotification('Failed to load definitions', 'error');
                        }
                    } catch (error) {
                        this.showNotification('Error connecting to server', 'error');
                    }
                    this.loading = false;
                },

                async loadInstances() {
                    this.loading = true;
                    try {
                        const response = await fetch(`${this.apiUrl}/instances`);
                        if (response.ok) {
                            this.instances = await response.json();
                        } else {
                            this.showNotification('Failed to load instances', 'error');
                        }
                    } catch (error) {
                        this.showNotification('Error connecting to server', 'error');
                    }
                    this.loading = false;
                },

                async startInstance(definitionId) {
                    try {
                        const response = await fetch(`${this.apiUrl}/workflows/${definitionId}/instances`, {
                            method: 'POST'
                        });
                        if (response.ok) {
                            const instance = await response.json();
                            this.showNotification(`Instance ${instance.id.slice(-8)} started successfully!`, 'success');
                            this.activeTab = 'instances';
                            await this.loadInstances();
                        } else {
                            this.showNotification('Failed to start instance', 'error');
                        }
                    } catch (error) {
                        this.showNotification('Error starting instance', 'error');
                    }
                },

                async executeAction(instanceId, actionId) {
                    try {
                        const response = await fetch(`${this.apiUrl}/instances/${instanceId}/actions/${actionId}`, {
                            method: 'POST'
                        });
                        if (response.ok) {
                            this.showNotification(`Action executed successfully!`, 'success');
                            await this.loadInstances();
                        } else {
                            const error = await response.text();
                            this.showNotification(`Failed to execute action: ${error}`, 'error');
                        }
                    } catch (error) {
                        this.showNotification('Error executing action', 'error');
                    }
                },

                getAvailableActions(instance) {
                    const definition = this.definitions.find(d => d.id === instance.definitionId);
                    if (!definition) return [];
                    
                    return definition.actions.filter(action => 
                        action.enabled && action.fromStates.includes(instance.currentState)
                    );
                },

                toggleHistory(instanceId) {
                    this.showHistory[instanceId] = !this.showHistory[instanceId];
                },

                addState() {
                    this.newWorkflow.states.push({
                        id: '',
                        name: '',
                        isInitial: false,
                        isFinal: false,
                        enabled: true
                    });
                },

                removeState(index) {
                    this.newWorkflow.states.splice(index, 1);
                },

                addAction() {
                    this.newWorkflow.actions.push({
                        id: '',
                        name: '',
                        enabled: true,
                        fromStatesStr: '',
                        toState: ''
                    });
                },

                removeAction(index) {
                    this.newWorkflow.actions.splice(index, 1);
                },

                async createWorkflow() {
                    this.creating = true;
                    
                    // Process actions to convert fromStatesStr to fromStates array
                    const processedActions = this.newWorkflow.actions.map(action => ({
                        id: action.id,
                        name: action.name,
                        enabled: action.enabled,
                        fromStates: action.fromStatesStr.split(',').map(s => s.trim()).filter(s => s),
                        toState: action.toState
                    }));

                    const workflowData = {
                        name: this.newWorkflow.name,
                        description: this.newWorkflow.description,
                        states: this.newWorkflow.states,
                        actions: processedActions
                    };

                    try {
                        const response = await fetch(`${this.apiUrl}/workflows`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(workflowData)
                        });

                        if (response.ok) {
                            this.showNotification('Workflow created successfully!', 'success');
                            this.resetForm();
                            this.activeTab = 'definitions';
                            await this.loadDefinitions();
                        } else {
                            const error = await response.text();
                            this.showNotification(`Failed to create workflow: ${error}`, 'error');
                        }
                    } catch (error) {
                        this.showNotification('Error creating workflow', 'error');
                    }
                    
                    this.creating = false;
                },

                resetForm() {
                    this.newWorkflow = {
                        name: '',
                        description: '',
                        states: [],
                        actions: []
                    };
                },

                viewDefinition(definition) {
                    alert(`Workflow: ${definition.name}\n\nStates: ${definition.states.map(s => s.name).join(', ')}\n\nActions: ${definition.actions.map(a => a.name).join(', ')}`);
                },

                showNotification(message, type = 'success') {
                    this.notification = {
                        show: true,
                        message,
                        type
                    };
                    setTimeout(() => {
                        this.notification.show = false;
                    }, 5000);
                }
            }
        }
    </script>
</body>
</html>